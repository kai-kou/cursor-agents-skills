---
description: コード変更時のデグレッション（リグレッション）防止ルール。3段階防御モデルのStage 1（保存時・常時適用）を定義し、変更リスクの分類基準とチェック手順を提供する。
globs:
alwaysApply: true
---

# デグレ防止ルール（Regression Prevention）

## 原則

> コード変更は常にデグレッション（既存機能の劣化）リスクを伴う。
> 変更前の影響評価・変更中のリスク意識・変更後の整合性確認を習慣化し、
> 3段階防御（Stage 1: 保存時 → Stage 2: コミット前 → Stage 3: プッシュ前）で品質を担保する。

---

## 3段階防御モデル（概要）

```
[Stage 1: 保存時]  ← ★ このルールが担当（軽量・即時）
      │
      ▼
[Stage 2: コミット前]  ← pre-commitフック + regression-guard（中程度）
      │
      ▼
[Stage 3: プッシュ前]  ← pre-pushフック + regression-guard + pre-push-review（包括的）
```

| Stage | トリガー | 所要時間 | 対象 | 実装 |
|-------|---------|---------|------|------|
| 1（本ルール） | ファイル保存・変更完了時 | 即時（< 1秒） | 変更されたファイル | このルール + エディタ設定 |
| 2 | git commit 実行時 | 5〜30秒 | ステージング済みファイル群 | pre-commitフック + regression-guard |
| 3 | git push 実行前 | 30秒〜3分 | リモートとの差分全体 | pre-pushフック + regression-guard + pre-push-review |

---

## Stage 1: 保存時チェック（常時適用）

ファイルを変更・保存するたびに、以下のチェックを実施すること:

### 1-1. 構文・フォーマットチェック

| チェック項目 | 対象 | アクション |
|------------|------|----------|
| Lintエラー | 全ファイル | 変更後にReadLintsで確認。自分が導入したエラーは即修正 |
| YAML構文 | `.yaml`, `.yml`, フロントマター付き`.md` | YAMLフロントマターのパースエラーがないこと |
| JSON構文 | `.json` | 構文エラーがないこと |
| Markdown構造 | `.md` | テーブル構造の崩れ、リンク切れがないこと |
| インデント | 全ファイル | プロジェクトの既存インデントスタイルと一致すること |

### 1-2. 整合性チェック

| チェック項目 | 対象 | アクション |
|------------|------|----------|
| YAMLフロントマター集計値 | tasks.md, milestones.md, sprint-backlog.md 等 | 集計値（total, completed, progress等）が実データと一致すること |
| 相互参照の有効性 | ファイル間で参照されるパス・ID | 参照先が実在すること。特にファイルパス・タスクID・マイルストーンID |
| テンプレート構造の維持 | テンプレートから生成されたファイル | 必須セクション・カラムが欠落していないこと |
| 命名の一貫性 | 新規作成するファイル・変数・関数 | プロジェクト内の既存命名規則に従うこと |

### 1-3. スコープチェック

| チェック項目 | アクション |
|------------|----------|
| タスクスコープ内か | 変更がタスクの完了条件に直接寄与するものであること |
| 「ついでに」変更していないか | タスクと無関係な修正を混入させないこと |
| 最小変更の原則 | 目的を達成する最小限の変更にとどめること |

---

## 変更リスク分類

### ファイルタイプ別リスクマトリクス

変更を行う際、対象ファイルのリスクレベルを意識すること:

| ファイルパターン | リスク | 理由 | 必要な注意 |
|----------------|--------|------|----------|
| `**/api/**`, `**/routes/**` | 🔴 高 | API互換性に影響 | 呼び出し元の確認必須 |
| `**/models/**`, `**/schema/**` | 🔴 高 | データ構造変更は広範囲に波及 | 全参照箇所の確認必須 |
| `**/config/**`, `*.env*`, `*.yaml`, `*.toml` | 🔴 高 | 環境・動作設定の変更 | 影響範囲の事前分析必須 |
| `**/auth/**`, `**/security/**` | 🔴 高 | セキュリティ関連は常に高リスク | セキュリティレビュー必須 |
| `**/agents/**`, `**/skills/**` | 🟡 中 | Agent/Skill定義変更は動作に影響 | 連携先の確認 |
| `**/rules/**`, `*.mdc` | 🟡 中 | ルール変更はワークフローに影響 | 既存ワークフローとの整合性確認 |
| `**/utils/**`, `**/lib/**`, `**/helpers/**` | 🟡 中 | 共有ユーティリティは参照箇所が多い | 利用箇所の確認 |
| `**/templates/**` | 🟡 中 | テンプレート変更は生成物に影響 | 生成済みファイルとの差分確認 |
| `**/tests/**`, `**/test/**`, `*_test.*` | 🟢 低 | テストコードの変更は本番に影響しない | テストが正しく通ること |
| `*.md`（ドキュメント）, `**/docs/**` | 🟢 低 | ドキュメントのみ | リンク切れ・情報の正確性 |
| `*.css`, `*.scss`, `*.less` | 🟢 低 | スタイル変更（機能影響なし） | 視覚的確認 |

### 変更種別リスク加重

| 変更種別 | リスク加重 | 必須アクション |
|---------|----------|-------------|
| ファイル削除 | ×3（最高） | 全参照箇所の確認。参照切れが発生しないこと |
| 関数/クラス/インターフェース削除 | ×3 | 使用箇所の全数確認 |
| インターフェース変更（引数追加/削除/型変更） | ×2 | 呼び出し元の全数修正 |
| 名前変更（リネーム） | ×2 | 参照箇所の全数更新。Grep で漏れを確認 |
| ロジック変更（既存関数の振る舞い変更） | ×1.5 | 影響を受ける機能のテスト・確認 |
| 新規追加 | ×0.5 | 既存機能への影響は低いが、整合性を確認 |
| コメント/ドキュメントのみの変更 | ×0 | 機能影響なし。情報の正確性のみ確認 |

---

## 変更前の必須チェック

ファイルを変更する**前に**、以下を確認すること:

### 🔴 高リスクファイルを変更する場合

1. **影響範囲の事前分析**: 変更が他のファイル・機能に与える影響をGrepで調査
2. **変更理由の明確化**: なぜこの変更が必要か、タスクの完了条件との関連を確認
3. **ロールバック計画**: 変更が問題を起こした場合の復元手順を把握

### 🟡 中リスクファイルを変更する場合

1. **参照箇所の確認**: このファイルを参照・利用している箇所をGrepで確認
2. **変更の影響範囲**: 連携先のファイル・機能への影響を把握

### 🟢 低リスクファイルを変更する場合

1. **基本的な整合性確認**: 構文エラー・リンク切れがないこと

---

## 変更後の必須チェック

ファイルを変更した**後に**、以下を確認すること:

1. **Lintエラー確認**: ReadLintsで変更ファイルをチェック。新規導入エラーは即修正
2. **YAMLフロントマター**: 集計値がある場合は再計算して正しいことを確認
3. **参照の有効性**: 変更・削除したファイル名・関数名・変数名が他で参照されていないか確認
4. **テンプレート整合性**: テンプレートから生成されたファイルを変更した場合、テンプレートとの乖離を認識

---

## Stage 2/3 エスカレーション条件

以下の条件に該当する場合、regression-guard エージェント（Stage 2/3）の実行を推奨する:

| 条件 | 推奨Stage | 理由 |
|------|----------|------|
| 🔴 高リスクファイルを3ファイル以上変更 | Stage 2以上 | 広範な影響分析が必要 |
| インターフェース/API定義の変更 | Stage 2以上 | 互換性の確認が必要 |
| ファイル削除を含む変更 | Stage 2以上 | 参照切れの包括的チェックが必要 |
| 変更ファイル数が10以上 | Stage 3 | クロスファイル影響分析が必要 |
| git push 前 | Stage 3 | リモートとの差分全体を分析 |
| 設定ファイル・環境変数の変更 | Stage 2以上 | 環境依存の副作用チェックが必要 |

### 起動方法

```
「デグレチェックして」      → Stage 2（ステージング済み変更）
「Push前にregression checkして」 → Stage 3（全未Pushコミット）
「Push前にレビューして」    → pre-push-review経由でStage 3
「このファイルの変更影響を分析して」 → 指定ファイル限定分析
```

---

## プロジェクトタイプ別チェック強化

### Markdown/ドキュメント系プロジェクト

AI Scrum Frameworkのようなドキュメント中心プロジェクトでは、以下を重点チェック:

| チェック対象 | 内容 | チェック方法 |
|------------|------|------------|
| テンプレート整合性 | テンプレートファイルと実ファイルの構造一致 | セクション・カラムの比較 |
| 相互参照の有効性 | ファイル間のリンク・パス参照が有効か | Grepでパス参照を確認 |
| YAMLフロントマターの整合性 | 集計値（total, completed等）が実データと一致 | 手動計算で検証 |
| タスクID/TRY-ID/PBI-IDの一意性 | ID重複がないこと | Grepで重複チェック |
| ファイルパスの有効性 | ドキュメント内で参照されるパスが実在 | Globで存在確認 |

### コード系プロジェクト（JavaScript/TypeScript/Python等）

| チェック対象 | 内容 | チェック方法 |
|------------|------|------------|
| import/require整合性 | 削除・リネームされたモジュールの参照 | Grepで参照パターン検索 |
| 型互換性 | インターフェース/型定義の変更影響 | TypeScript: tsc --noEmit |
| テストカバレッジ | 変更されたコードにテストがあるか | テストファイルの存在確認 |
| APIエンドポイント互換性 | ルーティング・ハンドラの変更影響 | API定義ファイルの確認 |
| 環境変数の整合性 | .env.example と実コードの一致 | 環境変数参照の検索 |

---

## 禁止事項

- ❌ Lintエラーを確認せずにタスク完了を報告すること
- ❌ 🔴高リスクファイルを影響分析なしに変更すること
- ❌ ファイル削除時に参照箇所を確認しないこと
- ❌ YAMLフロントマターの集計値を更新し忘れること
- ❌ 「ついでに」のスコープ外修正を混入させること
- ❌ 名前変更（リネーム）時に全参照箇所を更新し忘れること

---

## チェックリスト（タスク完了前の最終確認）

タスク完了を報告する前に、以下を確認すること:

- [ ] Stage 1チェック（構文・フォーマット）を実施したか
- [ ] Stage 1チェック（整合性）を実施したか
- [ ] Stage 1チェック（スコープ）を実施したか
- [ ] 🔴高リスクファイルの変更がある場合、影響分析を実施したか
- [ ] 新規導入したLintエラーがないか
- [ ] YAMLフロントマターの集計値は正しいか
- [ ] 参照切れ・リンク切れがないか
